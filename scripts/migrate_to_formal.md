# Migration Report: FLAP â€” FORD â†’ formal + VitePress

Reference implementation: `/home/stefano/fortran/PENF` (already migrated).

---

## 1. Create `docs/ford.md` (FORD project file, new location)

PENF moved its FORD config out of `doc/` and into `docs/ford.md` so `formal generate`
can find it naturally. FLAP needs the equivalent.

**Create `/home/stefano/fortran/FLAP/docs/ford.md`:**

```markdown
project: FLAP
src_dir: ../src
exclude_dir: ../src/third_party/PENF
             ../src/third_party/FACE
             ../src/third_party/fortran_tester
output_dir: html/publish/
project_github: https://github.com/szaghi/FLAP
summary: Fortran command Line Arguments Parser for poor people
author: Stefano Zaghi
github: https://github.com/szaghi
email: stefano.zaghi@gmail.com
md_extensions: markdown.extensions.toc
               markdown.extensions.smarty
               markdown.extensions.extra
docmark: <
display: public
         protected
         private
source: true
warn: true
graph: true
extra_mods: iso_fortran_env:https://gcc.gnu.org/onlinedocs/gfortran/ISO_005fFORTRAN_005fENV.html

{!../README.md!}
```

Key differences from `doc/main_page.md`: exclude entire `third_party/` subtrees (not
just PENF tests), and reference `../README.md` directly instead of the `README-FLAP.md`
symlink.

---

## 2. Run `formal init` and `formal generate`

```bash
scripts/migrate_to_formal.sh \
  --name FLAP \
  --ford-file docs/ford.md \
  --docs-dir docs \
  --update-fobos \
  --update-ci \
  --dry-run          # preview first
```

Then without `--dry-run`. This creates:
- `docs/.vitepress/config.mts`
- `docs/index.md`
- `docs/package.json` (with esbuild override pinned to `>=0.25.0`)
- `docs/api/` â€” one Markdown file per Fortran module

---

## 3. Customise `docs/.vitepress/config.mts`

PENF's config uses several things that FLAP's auto-generated one will lack. After
`formal init`, edit `docs/.vitepress/config.mts` to match the PENF pattern:

```ts
import { withMermaid } from 'vitepress-plugin-mermaid'
import apiSidebar from '../api/_sidebar.json'

export default withMermaid({
  title: 'FLAP Documentation',
  base: '/FLAP/',
  markdown: {
    math: true,
    languages: ['fortran-free-form', 'fortran-fixed-form'],
    languageAlias: {
      'fortran': 'fortran-free-form',
      'f90': 'fortran-free-form',
      'f03': 'fortran-free-form',
      'f08': 'fortran-free-form',
    },
  },
  themeConfig: {
    nav: [
      { text: 'Home', link: '/' },
      { text: 'API', link: '/api/' },
    ],
    sidebar: {
      '/api/': [
        { text: 'API Reference', items: [{ text: 'Overview', link: '/api/' }] },
        ...apiSidebar,
      ],
    },
    search: { provider: 'local' },
  },
  mermaid: {},
})
```

Add `vitepress-plugin-mermaid` and `mermaid` to `docs/package.json` devDependencies
(PENF has both).

---

## 4. Write `docs/index.md` (landing page)

Replace the generated stub with a proper VitePress home page, modelled on PENF's:

```markdown
---
layout: home

hero:
  name: FLAP
  text: Fortran command Line Arguments Parser for poor people
  tagline: A KISS, pure Fortran library for building CLIs, inspired by Python's argparse
  actions:
    - theme: brand
      text: API Reference
      link: /api/
    - theme: alt
      text: View on GitHub
      link: https://github.com/szaghi/FLAP

features:
  - icon: ðŸ–¥ï¸
    title: Argparse-style API
    details: ...
  - icon: ðŸ”€
    title: Nested subcommands
    details: ...
  ...
---
```

The `docs/guide/` directory in PENF contains hand-written prose pages
(`index.md`, `stringify.md`, `utilities.md`, `memory.md`, `contributing.md`)
that are not generated by `formal` â€” they were authored manually and wired into
the VitePress sidebar. For FLAP, decide which equivalent guide pages to write
(e.g. a quick-start, "adding arguments" walkthrough, subcommands tutorial).
This is optional for the initial migration but makes the site richer than a
bare API dump.

---

## 5. Update `fobos` â€” `[rule-makedoc]` and `[rule-deldoc]`

**Current (FORD):**

```ini
[rule-makedoc]
help   = Build documentation from source files
rule_1 = rm -rf doc/html/*
rule_2 = ford doc/main_page.md --debug
rule_3 = cp -r doc/html/publish/* doc/html/
rule_4 = rm -rf doc/html/publish

[rule-deldoc]
help = Delete documentation
rule = rm -rf doc/html/*
```

**Target (formal + VitePress) â€” matching PENF exactly:**

```ini
[rule-makedoc]
help   = Build documentation with formal + VitePress
rule_1 = formal generate --mirror-sources --diagrams --project docs/ford.md --output docs/api
rule_2 = cd docs && npm ci && npm run docs:build

[rule-deldoc]
help = Delete documentation build artifacts
rule = rm -rf docs/.vitepress/dist/ docs/.vitepress/cache/ docs/api/
```

Note the flags `--mirror-sources --diagrams` used in PENF but absent from the
`migrate_to_formal.sh` default â€” add them manually after the script runs.

---

## 6. Create `.github/actions/setup-flap/action.yml`

PENF uses a composite action for reusable setup. Create the equivalent for FLAP:

```yaml
name: Setup FLAP build environment
description: Install GCC and Python build tools required by CI and release jobs

inputs:
  gcc-version:
    description: GCC version to install
    default: '14'
  extra-pip-packages:
    description: Space-separated list of additional pip packages
    default: ''

runs:
  using: composite
  steps:
    - name: Install GCC
      shell: bash
      run: |
        sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test
        sudo apt update
        sudo apt install -y \
          gcc-${{ inputs.gcc-version }} \
          gfortran-${{ inputs.gcc-version }} \
          g++-${{ inputs.gcc-version }} \
          graphviz
        sudo update-alternatives \
          --install /usr/bin/gcc      gcc      /usr/bin/gcc-${{ inputs.gcc-version }}      100 \
          --slave   /usr/bin/gfortran gfortran /usr/bin/gfortran-${{ inputs.gcc-version }} \
          --slave   /usr/bin/gcov     gcov     /usr/bin/gcov-${{ inputs.gcc-version }}

    - name: Install Python tools
      shell: bash
      run: |
        pip install \
          markdown markdown-include python-markdown-math \
          toposort jinja2 pygments beautifulsoup4 \
          tqdm importlib-metadata ford FoBiS.py \
          ${{ inputs.extra-pip-packages }}

    - name: Check system
      shell: bash
      run: |
        gfortran --version
        gcov --version
        FoBiS.py --version
        ford --version
```

---

## 7. Rewrite `.github/workflows/ci.yml`

PENF's CI is lean: **tests + coverage only** on every push/PR; docs and releases
are handled by `release.yml`.

**Target `ci.yml` for FLAP:**

```yaml
name: CI

on:
  push:
    branches: ["**"]
    tags-ignore: ["**"]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Setup build environment
      uses: ./.github/actions/setup-flap

    - name: Run tests with coverage
      run: FoBiS.py rule -ex makecoverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
```

---

## 8. Create `.github/workflows/release.yml`

FLAP has no `release.yml`. Adapt PENF's verbatim, substituting `PENF` â†’ `FLAP`
and `setup-penf` â†’ `setup-flap`:

```yaml
name: Release

on:
  push:
    tags: ["v[0-9]+.[0-9]+.[0-9]+"]

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Setup build environment
      uses: ./.github/actions/setup-flap
      with:
        extra-pip-packages: formal-ford2vitepress

    - name: Check formal version
      run: formal --version

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    # â”€â”€ Tests & coverage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Run tests with coverage
      run: FoBiS.py rule -ex makecoverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

    # â”€â”€ Documentation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build documentation
      run: |
        formal generate --mirror-sources --diagrams --project docs/ford.md --output docs/api
        cd docs && npm ci && npm run docs:build

    - name: Deploy docs to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: docs/.vitepress/dist

    # â”€â”€ Release artefact â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build release tarball
      run: |
        VERSION="${{ github.ref_name }}"
        tar --xform="s%^%FLAP-${VERSION}/%" -czf "FLAP-${VERSION}.tar.gz" \
          --exclude='.git' \
          --exclude='docs/node_modules' \
          --exclude='docs/.vitepress/dist' \
          --exclude='docs/.vitepress/cache' \
          --exclude='exe' --exclude='obj' --exclude='mod' \
          *
        echo "TARBALL=FLAP-${VERSION}.tar.gz" >> $GITHUB_ENV

    # â”€â”€ Release notes from CHANGELOG.md â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Extract release notes from CHANGELOG.md
      run: |
        python3 - "${{ github.ref_name }}" CHANGELOG.md > release_notes.md <<'PYEOF'
        import sys, re
        tag, path = sys.argv[1], sys.argv[2]
        with open(path) as f:
            content = f.read()
        pattern = rf'(## \[{re.escape(tag)}\].*?)(?=\n## |\Z)'
        match = re.search(pattern, content, re.DOTALL)
        print(match.group(1).strip() if match else f"Release {tag}\n\nSee CHANGELOG.md for details.")
        PYEOF

    # â”€â”€ Publish GitHub release â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Publish GitHub release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref_name }}
        name: ${{ github.ref_name }}
        body_path: release_notes.md
        files: |
          ${{ env.TARBALL }}
          scripts/install.sh
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

---

## 9. Add `cliff.toml` and generate `CHANGELOG.md`

Copy PENF's `cliff.toml` and substitute `PENF` â†’ `FLAP` in all GitHub URLs:

```toml
[changelog]
header = "# Changelog\n"
body = """
{% if version %}\
## [{{ version }}](https://github.com/szaghi/FLAP/tree/{{ version }}) \
({{ timestamp | date(format="%Y-%m-%d") }})
{% if previous.version %}\
[Full Changelog](https://github.com/szaghi/FLAP/compare/{{ previous.version }}...{{ version }})
{% endif %}\
{% else %}\
## [Unreleased]
{% endif %}\
{% for group, commits in commits | group_by(attribute="group") %}\
### {{ group | upper_first }}
{% for commit in commits %}\
- {{ commit.message | upper_first }}\
{% if commit.breaking %} âš  **BREAKING CHANGE**{% endif %} \
([`{{ commit.id | truncate(length=7, end="") }}`](https://github.com/szaghi/FLAP/commit/{{ commit.id }}))
{% endfor %}
{% endfor %}\
"""
trim = true
footer = ""

[git]
conventional_commits = true
filter_unconventional = false
split_commits = false

commit_preprocessors = [
  { pattern = '#([0-9]+)', replace = "[#$1](https://github.com/szaghi/FLAP/issues/$1)" },
]

commit_parsers = [
  { message = "^feat",                group = "New features" },
  { message = "^fix",                 group = "Bug fixes" },
  { message = "^perf",                group = "Performance" },
  { message = "^refactor",            group = "Refactoring" },
  { message = "^docs",                group = "Documentation" },
  { message = "^test",                group = "Testing" },
  { message = "^build",               group = "Build system" },
  { message = "^ci",                  group = "CI/CD" },
  { message = "^chore\\(release\\)",  skip = true },
  { message = "^chore",               group = "Miscellaneous" },
  { message = ".*",                   group = "Miscellaneous" },
]

protect_breaking_commits = true
filter_commits = false
tag_pattern = "v[0-9]+\\.[0-9]+\\.[0-9]+"
sort_commits = "oldest"
```

Then generate the initial `CHANGELOG.md`:

```bash
git-cliff --output CHANGELOG.md
```

---

## 10. Update `.gitignore`

Add VitePress build artifacts (currently absent from FLAP's `.gitignore`):

```
# VitePress
docs/node_modules/
docs/.vitepress/dist/
docs/.vitepress/cache/
```

---

## 11. Install npm dependencies and verify locally

```bash
cd docs && npm install
npm run docs:dev     # â†’ http://localhost:5173/FLAP/
npm run docs:build   # full production build
```

---

## Order of operations

```
1.  Create docs/ford.md
2.  Run scripts/migrate_to_formal.sh \
      --name FLAP --ford-file docs/ford.md \
      --update-fobos --update-ci
3.  Manually add --mirror-sources --diagrams to fobos [rule-makedoc]
4.  Customise docs/.vitepress/config.mts  (withMermaid, Fortran aliases, sidebar)
5.  Write docs/index.md                   (hero landing page)
6.  Add cliff.toml                        (copy PENF's, swap URLs)
7.  Run: git-cliff --output CHANGELOG.md
8.  Create .github/actions/setup-flap/action.yml
9.  Rewrite .github/workflows/ci.yml     (tests-only, no docs)
10. Create .github/workflows/release.yml  (tag-triggered, docs + release)
11. Add VitePress entries to .gitignore
12. cd docs && npm install && npm run docs:dev  (verify)
```

---

## Summary table

| # | File / Action | FLAP current | PENF reference | Delta |
|---|---|---|---|---|
| 1 | `docs/ford.md` | Missing | `docs/ford.md` | Create |
| 2 | `formal init + generate` | Not run | Done | Run |
| 3 | `docs/.vitepress/config.mts` | Missing | `withMermaid`, Fortran aliases, API sidebar | Create & customise |
| 4 | `docs/index.md` | Missing | Hero + features layout | Write |
| 5 | `fobos` `[rule-makedoc/deldoc]` | FORD-based | `formal generate` + VitePress | Edit |
| 6 | `.github/actions/setup-flap/` | Missing | Composite action | Create |
| 7 | `.github/workflows/ci.yml` | Monolithic, runs on all pushes | Tests + coverage only | Rewrite |
| 8 | `.github/workflows/release.yml` | Missing | Full release pipeline | Create |
| 9 | `cliff.toml` | Missing | Present | Create |
| 9b | `CHANGELOG.md` | Missing | Present | Generate via `git-cliff` |
| 10 | `.gitignore` | No VitePress entries | Has VitePress entries | Append |
| 11 | `docs/node_modules` | Missing | Present (gitignored) | `npm install` |
